<!-- file_manager/templates/file_manager/display.html -->
{% extends 'file_manager/base.html' %}
{% load static %}

{% block title %}{{ file.filename }} - Gestor de Archivos{% endblock %}

{% block extra_js %}
<script src="{% static 'file_manager/js/ml_actions.js' %}"></script>
{% endblock %}

{% block content %}
<!-- File Header -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h3 class="mb-2">
                            <i class="bi bi-file-earmark-text"></i> {{ file.filename }}
                        </h3>
                        <p class="text-muted mb-0">
                            <span class="file-type-badge badge-{{ file.file_type }} me-2">{{ file.file_type|upper
                                }}</span>
                            {{ file.get_file_size_display }} •
                            Subido: {{ file.uploaded_at|date:"d/m/Y H:i" }}
                        </p>
                    </div>
                    <div>
                        <a href="{{ file.file.url }}" download class="btn btn-primary">
                            <i class="bi bi-download"></i> Descargar
                        </a>
                        <a href="{% url 'file_manager:file_list' %}" class="btn btn-outline-secondary">
                            <i class="bi bi-arrow-left"></i> Volver
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ML Actions Panel -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-primary shadow-sm">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-cpu"></i> Acciones de Machine Learning</h5>
                <span class="badge bg-light text-primary">Beta</span>
            </div>
            <div class="card-body">
                <p class="card-text">Selecciona una acción para analizar el contenido del archivo utilizando modelos
                    entrenados.</p>
                <div class="d-flex flex-wrap gap-2">
                    {% if file.file_type == 'txt' or file.file_type == 'text' %}
                    <button class="btn btn-outline-primary process-btn" data-action="spam_check"
                        data-file-id="{{ file.pk }}" data-url="{% url 'file_manager:process_file' file.pk %}">
                        <i class="bi bi-shield-check"></i> Detectar Spam
                    </button>
                    {% endif %}

                    {% if file.file_type == 'arff' %}
                    <button class="btn btn-outline-primary process-btn" data-action="intrusion_check"
                        data-file-id="{{ file.pk }}" data-url="{% url 'file_manager:process_file' file.pk %}">
                        <i class="bi bi-network-7-gradient"></i> Análisis de Intrusión (NSL-KDD)
                    </button>
                    {% endif %}

                    <button class="btn btn-outline-secondary disabled" title="Próximamente">
                        <i class="bi bi-link-45deg"></i> Análisis de URLs Maliciosas
                    </button>
                </div>

                <!-- Loading Indicator -->
                <div id="ml-loading-overlay" class="d-none mt-4 text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Procesando...</span>
                    </div>
                    <p class="mt-2 text-muted">Analizando archivo con modelos de ML...</p>
                </div>

                <!-- Result Area -->
                <div id="ml-result-panel" class="d-none mt-4 p-4 border rounded bg-light glass">
                    <h6 class="text-uppercase text-muted mb-3">Resultado del Análisis</h6>
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h4 id="ml-result-task" class="mb-1">Tarea</h4>
                            <p id="ml-result-text" class="h5 mb-2">Resultado</p>
                            <p id="ml-result-details" class="text-muted mb-0">Detalles...</p>
                        </div>
                        <div class="col-md-4 text-end">
                            <i class="bi bi-check-circle-fill text-success" style="font-size: 3rem;"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- File Content -->
{% if processing_success %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-white">
                <h5 class="mb-0">
                    <i class="bi bi-eye"></i> Vista Previa del Archivo
                </h5>
            </div>
            <div class="card-body">

                {% if file_content.type == 'csv' %}
                <!-- CSV Display -->
                <div class="table-responsive">
                    {{ file_content.html_content|safe }}
                </div>
                {% if file_content.is_truncated %}
                <div class="alert alert-info mt-3">
                    <i class="bi bi-info-circle"></i>
                    Mostrando {{ file_content.rows_displayed }} de {{ file_content.rows_total }} filas.
                    <a href="{{ file.file.url }}" download>Descarga el archivo completo</a>.
                </div>
                {% endif %}
                <div class="mt-3">
                    <small class="text-muted">
                        <strong>Columnas:</strong> {{ file_content.column_count }} •
                        <strong>Filas:</strong> {{ file_content.rows_total }}
                    </small>
                </div>

                {% elif file_content.type == 'txt' %}
                <!-- TXT Display -->
                <pre class="mb-0">{{ file_content.content }}</pre>
                {% if file_content.is_truncated %}
                <div class="alert alert-info mt-3">
                    <i class="bi bi-info-circle"></i>
                    Mostrando {{ file_content.lines_displayed }} de {{ file_content.lines_total }} líneas.
                    <a href="{{ file.file.url }}" download>Descarga el archivo completo</a>.
                </div>
                {% endif %}
                <div class="mt-3">
                    <small class="text-muted">
                        <strong>Líneas:</strong> {{ file_content.lines_total }} •
                        <strong>Caracteres:</strong> {{ file_content.characters }}
                    </small>
                </div>

                {% elif file_content.type == 'json' %}
                <!-- JSON Display -->
                <pre class="mb-0"><code>{{ file_content.content }}</code></pre>
                <div class="mt-3">
                    <small class="text-muted">
                        <strong>Tipo:</strong> {{ file_content.data_type }}
                        {% if file_content.item_count %}
                        • <strong>Elementos:</strong> {{ file_content.item_count }}
                        {% endif %}
                    </small>
                </div>

                {% elif file_content.type == 'html' %}
                <!-- HTML Display -->
                <ul class="nav nav-tabs mb-3" role="tablist">
                    <li class="nav-item">
                        <a class="nav-link active" data-bs-toggle="tab" href="#codeView">
                            <i class="bi bi-code-square"></i> Código Fuente
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#renderView">
                            <i class="bi bi-eye"></i> Vista Renderizada
                        </a>
                    </li>
                </ul>

                <div class="tab-content">
                    <div id="codeView" class="tab-pane fade show active">
                        <pre class="mb-0"><code>{{ file_content.code_view }}</code></pre>
                    </div>
                    <div id="renderView" class="tab-pane fade">
                        <div class="alert alert-warning">
                            <i class="bi bi-exclamation-triangle"></i>
                            <strong>Advertencia:</strong> El contenido HTML se muestra tal como está.
                            Ten precaución con archivos de fuentes desconocidas.
                        </div>
                        <div class="border rounded p-3">
                            {{ file_content.raw_content|safe }}
                        </div>
                    </div>
                </div>

                <div class="mt-3">
                    <small class="text-muted">
                        <strong>Líneas:</strong> {{ file_content.lines }} •
                        <strong>Caracteres:</strong> {{ file_content.characters }}
                    </small>
                </div>
                {% endif %}

            </div>
        </div>
    </div>
</div>

{% else %}
<!-- Error Display -->
<div class="row">
    <div class="col-12">
        <div class="alert alert-danger">
            <h5><i class="bi bi-exclamation-triangle"></i> Error al Procesar el Archivo</h5>
            <p class="mb-0">{{ error_message }}</p>
        </div>
        <div class="text-center">
            <a href="{{ file.file.url }}" download class="btn btn-primary">
                <i class="bi bi-download"></i> Descargar Archivo Original
            </a>
        </div>
    </div>
</div>
{% endif %}

{% endblock %}